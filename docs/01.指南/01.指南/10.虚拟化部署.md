---
title: è™šæ‹ŸåŒ–éƒ¨ç½²
date: 2023-06-08
permalink: /pages/build-docker/
---

## è™šæ‹ŸåŒ–éƒ¨ç½²

### `Caddy`

åœ¨è™šæ‹ŸåŒ–éƒ¨ç½²ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`Caddy`ä½œä¸ºåå‘ä»£ç†ç”¨äºå“åº”å‰ç«¯ä»£ç ï¼Œæœ¬æ•™ç¨‹ä¸­å°†ä¸ä¼šè€ƒè™‘å‰ç«¯åå‘ä»£ç†æœåŠ¡å™¨å†æ¬¡ä»£ç†åç«¯è·¯å¾„ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šè€ƒè™‘è·¨åŸŸçš„é—®é¢˜ï¼Œè·¨åŸŸé—®é¢˜åº”è¯¥ç”±åç«¯è‡ªè¡Œè§£å†³ï¼Œè€Œä¸æ˜¯ä¾é å‰ç«¯çš„å†æ¬¡åä»£ã€‚è™½ç„¶`Caddy`ä¹Ÿå¯ä»¥å†æ¬¡åä»£è¯¸å¦‚ï¼š`/api`,`/otherApi`ç­‰ï¼Œä½†åŸºäºä¸ªäººä¹ æƒ¯ï¼Œæˆ‘å¹¶ä¸å–œæ¬¢è¿™æ ·åšï¼ŒåŸå› æœ‰ä¸¤ç‚¹ï¼š

- ç”¨åŒåŸŸåçš„`path`æ¥è§£å†³è·¨åŸŸä¼šé€ æˆå‰ç«¯é…ç½®ç¹ç
- åŒåŸŸåè¯·æ±‚çš„æ¯æ¬¡è¯·æ±‚éƒ½ä¼šå¸¦ä¸Šè¯¥åŸŸåä¸‹çš„`cookie`ä¿¡æ¯,å¢åŠ ç½‘ç»œå¼€é”€

#### ç›¸å…³é…ç½®æ–‡ä»¶

ä½ éœ€è¦æ–°å¢ä¸¤ä¸ªæ–‡ä»¶åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸­ï¼Œåˆ†åˆ«æ˜¯`Dockerfile`å’Œ`Caddyfile`

`Dockerfile`çš„å†…å®¹å¦‚ä¸‹

```Docker
FROM node:lts-alpine as builder

WORKDIR /app

COPY . .
RUN set -xe \
  && node -v \
  && npm install -g pnpm \
  && pnpm install \
  && pnpm build

# è¿è¡Œç¯å¢ƒ
FROM caddy:2-alpine

ENV TZ Asia/Shanghai

RUN set -xe \
  && apk -U upgrade \
  && apk add --update --no-cache --virtual .build-deps \
  tzdata \
  && cp /usr/share/zoneinfo/${TZ} /etc/localtime \
  # åˆ é™¤ä¸å¿…è¦çš„ä¸œè¥¿
  && apk del .build-deps \
  && rm -rf /tmp/*

COPY --from=builder /app/dist /var/www/html

ADD ./Caddyfile /etc/caddy/Caddyfile

RUN /usr/bin/caddy fmt --overwrite /etc/caddy/Caddyfile

EXPOSE 80
```

`Caddyfile`çš„å†…å®¹å¦‚ä¸‹

```
:80 {
	encode zstd gzip
    file_server {
        root /var/www/html
    }
}
```

å› ä¸ºåŸºäºè™šæ‹ŸåŒ–çš„é¡¹ç›®ï¼ŒåŸºæœ¬ä¸å¯èƒ½åªæœ‰ä¸€ä¸ªå®¹å™¨æä¾›http(s)æœåŠ¡ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦`Caddy`æ¥è‡ªåŠ¨ç”³è¯·sslè¯ä¹¦ï¼Œä»…ä»…æä¾›httpæœåŠ¡å³å¯ã€‚

### CI/CD

æˆ‘ä»¬ä¸€èˆ¬æ¥è¯´å¯¹äºé¡¹ç›®éƒ½æ˜¯è‡ªåŠ¨å‘å¸ƒæ‰“åŒ…çš„ï¼Œæˆ‘æœ¬äººä½¿ç”¨çš„æ˜¯ç§æœ‰åŒ–çš„`git`å’Œ`docker`ä»“åº“ï¼Œæ‰€ä»¥è¿™é‡Œæä¾›çš„æ ·ä¾‹ä»…ä¾›å‚è€ƒã€‚

æˆ‘çš„å¼€å‘ç›¸å…³æœåŠ¡åˆ†åˆ«æ˜¯`gitea`,`drone`,`harbor`

é‚£ä¹ˆåªéœ€è¦åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­æ–°å¢ä¸€ä¸ª`.drone.yml`æ–‡ä»¶ï¼Œå¹¶åœ¨`drone`ä¸­å¼€å¯å³å¯ã€‚

`.drone.yml`

```yml
kind: pipeline
name: goAdmin-å‰ç«¯
type: docker

clone:
  depth: 1

steps:
  - name: build-image-and-push
    pull: if-not-exists
    image: plugins/docker
    settings:
      storage_driver: vfs
      tags:
        - latest
        - ${DRONE_BUILD_NUMBER}
      insecure: true
      use_cache: true
      registry:
        from_secret: harbor_address
      repo:
        from_secret: harbor_repo
      username:
        from_secret: harbor_user
      password:
        from_secret: harbor_pass
      context: ./
      dockerfile: ./Dockerfile
    when:
      status:
        - success

  - name: deploy
    image: alpine
    pull: if-not-exists
    commands:
      - sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories
      - apk update
      - apk --no-cache add curl
      # portainer hook
      - curl -XPOST http://192.168.1.9:9000/api/stacks/webhooks/e6b5d7e5-1aea-410e-854b-8fb01cd9fd37

  - name: send telegram notification
    image: appleboy/drone-telegram
    pull: if-not-exists
    when:
      status:
        - success
        - failure
    settings:
      token:
        from_secret: telegram_token
      to:
        from_secret: telegram_to
      format: markdown
      message: >
        {{#success build.status}}
        âœ… Build #{{build.number}} of `{{repo.name}}` succeeded.
        ğŸ“ Commit by {{commit.author}} on `{{commit.branch}}`:
        ```
        {{commit.message}}
        ```
        ğŸŒ {{ build.link }}
        {{else}}
        âŒ Build #{{build.number}} of `{{repo.name}}` failed.
        ğŸ“ Commit by {{commit.author}} on `{{commit.branch}}`:
        ```
        {{commit.message}}
        ```
        ğŸŒ {{ build.link }}
        {{/success}}

trigger:
  branch:
    - main
  event:
    - push

```

é…ç½®å¥½ä»¥åï¼Œå½“æˆ‘ä»¬åœ¨ä¸»åˆ†æ”¯`main`è¿›è¡Œæ¨é€çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨æ„å»ºé•œåƒï¼Œæ¨é€åˆ°ç§æœ‰hubï¼Œå¹¶ä¸”æ‰§è¡Œå¾€æœåŠ¡å™¨çš„éƒ¨ç½²äº†ã€‚è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯`portainer`ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªè¡Œäº†è§£ã€‚

> Tips: ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬åœ¨å¼€å‘çš„æ—¶å€™åº”å½“æ–°å»º`dev`åˆ†æ”¯ï¼Œå®Œæˆä¸€ä¸ªåŠŸèƒ½ä»¥ååˆå¹¶åˆ°ä¸»åˆ†æ”¯

### `Traefik`

æˆ‘ä»¬å°†ä½¿ç”¨`Traefik`ä½œä¸ºæ‰€æœ‰å®¹å™¨çš„tcp/udpåå‘ä»£ç†è½¯ä»¶ï¼Œä¸‹é¢å°†ç®€å•ä»‹ç»ä¸€ä¸‹`Traefik`çš„å®‰è£…ä½¿ç”¨

```yml
version: "3.3"
networks:
  work-net:
    external: true
    
services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: always
    command:
      # http
      - --entrypoints.web.address=:80
      # global redirect to https
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      # https
      - --entrypoints.websecure.address=:443
      # å¿½ç•¥åç«¯è¯ä¹¦éªŒè¯
      - --serversTransport.insecureSkipVerify=true
      # ç¦æ­¢è‡ªåŠ¨å‘ç°å®¹å™¨å¹¶ä»£ç†
      - --providers.docker.exposedByDefault=false
      - --log.level=ERROR
      # è¯ä¹¦ç”³è¯·é…ç½®
      - --certificatesresolvers.leresolver.acme.httpchallenge=true
      # ç”³è¯·è¯ä¹¦ä½¿ç”¨çš„email
      - --certificatesresolvers.leresolver.acme.email=you@domain.com 
      - --certificatesresolvers.leresolver.acme.storage=/acme/acme.json
      - --certificatesresolvers.leresolver.acme.httpchallenge.entrypoint=web
    ports:
      - "80:80"
      - "443:443"
    networks:
      - work-net
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "acme:/acme"
    labels:
      # watchtower è‡ªåŠ¨æ›´æ–°å®¹å™¨
      - com.centurylinklabs.watchtower.enable=true
      - traefik.enable=true
      # redirect to nonwww
      - traefik.http.middlewares.redirect-to-nonwww.redirectregex.regex=^https?://(?:www\.)?(.+)
      - traefik.http.middlewares.redirect-to-nonwww.redirectregex.replacement=https://$${1}
      # compress gzip
      - traefik.http.middlewares.gzip-compress.compress=true
      - traefik.http.middlewares.gzip-compress.compress.excludedcontenttypes=text/event-stream
volumes:
  acme:
    name: traefik_acme
```

è¿™é‡Œæˆ‘ä»¬ç®€å•ä½¿ç”¨åŸºäºhttpçš„80ç«¯å£æ¥ç”³è¯·è¯ä¹¦ï¼Œ`traefik`ä¹Ÿæ”¯æŒDNSçš„è¯ä¹¦ç”³è¯·ï¼Œå¯ç”¨äºæ— å…¬ç½‘IPçš„ä¸»æœºç”³è¯·sslè¯ä¹¦ï¼Œå…·ä½“è¯·è‡ªè¡Œå­¦ä¹ ã€‚

åŒæ—¶è¿™é‡Œä½ æœ€å¥½é…ç½®ä¸€ä¸ª`docker`çš„ç½‘ç»œï¼Œæ¯”å¦‚è¿™é‡Œçš„ç½‘ç»œåç§°æ˜¯`work-net`ï¼Œå¦‚ä¸éœ€è¦ï¼Œè¯·åˆ é™¤ç›¸å…³çš„é…ç½®ï¼ŒåŒ…æ‹¬ä¸‹é¢çš„å¯¹é¡¹ç›®é…ç½®çš„`docker`ç½‘ç»œã€‚

å½“`traefik`è¿è¡Œèµ·æ¥ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹éƒ¨ç½²æˆ‘ä»¬çš„é¡¹ç›®äº†ã€‚

```yml
version: '3'

networks:
  work-net:
    external: true

services:
  go-admin-front:
    image: harbor.****.com:8899/drone/go-admin-front:latest
    container_name: go-admin-front
    restart: always
    networks:
      - work-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app-go-admin-front.rule=Host(`admin.fabraze.com`)"
      - "traefik.http.routers.app-go-admin-front.tls=true"
      - "traefik.http.routers.app-go-admin-front.tls.certresolver=leresolver"
      - "traefik.http.routers.app-go-admin-front.entrypoints=websecure"
      - "traefik.http.routers.app-go-admin-front.service=srv-go-admin-front"
      - "traefik.http.services.srv-go-admin-front.loadbalancer.server.port=80"
```

**æ³¨æ„**

- `traefik.http.routers.app-go-admin-front.tls.certresolver=leresolver` è¿™é‡Œçš„ `leresolver` æ˜¯ä¸`Traefik`è¯ä¹¦ç”³è¯·é…ç½®é‡Œçš„åå­—ä¸€è‡´çš„ã€‚
- `app-go-admin-front`ï¼Œ`srv-go-admin-front` è¿™ä¸¤ä¸ªåå­—å¯ä»¥ä»»æ„è‡ªè¡Œå®šä¹‰ï¼Œä½†æ˜¯ä¸å¯ä»¥å’Œå…¶å®ƒå®¹å™¨çš„åç§°ä¸€è‡´ï¼Œå¿…é¡»å”¯ä¸€
